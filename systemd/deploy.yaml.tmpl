# Uses Env variable JUMP_USER to replace {{ .JumpUser }}
---
apiVersion: v1
kind: Secret
metadata:
  name: deploy-jump-ssh
  namespace: default
data:
  authorized_keys: '{{ $home := .Home }}{{ cat $home "/.ssh/id_rsa.pub" | file2string  | base64Encode }}'
  config: '{{ file2string "systemd/dot.ssh/config" | base64Encode }}'

---
# for versions before 1.8.0 use apps/v1beta1
apiVersion: apps/v1beta2
kind: Deployment
metadata:
  name: deploy-jump-ssh
  namespace: default
  labels:
    app: ssh
spec:
  replicas: 2
  selector:
    matchLabels:
      name: deploy-jump-ssh
  template:
    metadata:
      labels:
        name: deploy-jump-ssh
    spec:
      containers:
      - name: ssh
        image: {{.DockerUser}}/debian-stretch-slim-ssh:latest
        # imagePullPolicy: IfNotPresent
        imagePullPolicy: Always
        securityContext:
          privileged: true
        ports:
        - containerPort: 22
          name: ssh
        volumeMounts:
        - name: ssh
          mountPath: /home/{{ .JumpUser }}/ssh
          readOnly: false
        - mountPath: /sys/fs/cgroup
          name: fs-cgroup
      volumes:
      - name: ssh
        secret:
          secretName: deploy-jump-ssh
          defaultMode: 420
      - name: fs-cgroup
        hostPath:
          path: /sys/fs/cgroup
      terminationGracePeriodSeconds: 30
      dnsPolicy: ClusterFirstWithHostNet

# ------------------------- Service ------------------------- #
---
apiVersion: v1
kind: Service
metadata:
  name: deploy-jump-ssh
  labels:
    app: deploy-jump-ssh
spec:
  ports:
  - port: 2222
    targetPort: 22
    name: ssh
  loadBalancerIP: 192.168.0.222
  type: LoadBalancer
  selector:
    name: deploy-jump-ssh

# local variables:
# mode: yaml
# end:

